<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GeoSIGPAC Web Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#006d3e', // Agricultural Green
                        secondary: '#4c6356',
                        accent: '#eab308',
                        background: '#f8fafc',
                        surface: '#ffffff'
                    }
                }
            }
        }
    </script>
    <style>
        /* Touch optimization */
        body {
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }
        /* Hide scrollbar globally */
        html, body {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        ::-webkit-scrollbar {
            display: none;
        }
        .project-card {
            transition: transform 0.15s ease-out;
        }
        .project-card:active {
            transform: scale(0.98);
        }
    </style>
</head>
<body class="bg-background text-gray-800 antialiased pb-24">

    <!-- Header -->
    <header class="bg-primary text-white p-4 sticky top-0 z-50 shadow-lg flex justify-between items-center">
        <div class="flex items-center gap-3">
            <div class="bg-white/20 p-2 rounded-full backdrop-blur-sm">
                <!-- Icono Mapa -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 7V5c0-1.1.9-2 2-2h2"></path><path d="M17 3h2c1.1 0 2 .9 2 2v2"></path><path d="M21 17v2c0 1.1-.9 2-2 2h-2"></path><path d="M7 21H5c-1.1 0-2-.9-2-2v-2"></path><circle cx="12" cy="12" r="3"></circle><path d="M12 16v3"></path><path d="M12 8V5"></path><path d="M16 12h3"></path><path d="M8 12H5"></path></svg>
            </div>
            <div>
                <h1 class="font-bold text-lg leading-tight">GeoSIGPAC</h1>
                <p class="text-[10px] uppercase tracking-wider opacity-80">Gestor de Parcelas</p>
            </div>
        </div>
        <!-- Botón Debug -->
        <button onclick="window.Android.showToast('Conexión Activa')" class="p-2 active:bg-white/10 rounded-full transition-colors text-xs border border-white/20">
            Estado
        </button>
    </header>

    <!-- Project List -->
    <main id="project-list" class="p-4 space-y-4">
        <div class="flex justify-center mt-10">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
        </div>
    </main>

    <!-- FAB: Test Camera Button -->
    <button onclick="handleCamera('test_project_id')" 
            class="fixed bottom-6 right-6 px-6 h-14 bg-secondary text-white rounded-2xl shadow-xl flex items-center justify-center gap-2 hover:bg-primary transition-colors active:scale-95 z-40 font-bold">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
        Probar Cámara
    </button>

    <script>
        // --- STATE ---
        let projects = [];

        // --- ANDROID BRIDGE MOCK (Browser Dev) ---
        if (typeof window.Android === 'undefined') {
            window.Android = {
                getProjects: () => JSON.stringify([
                    { id: 'demo1', name: 'Parcela Demo Browser', description: 'Sin conexión nativa', lat: 40.4168, lng: -3.7038, date: '2023-10-30', status: 'pending', imageUrl: null }
                ]),
                showToast: (msg) => console.log('Native Toast:', msg),
                onProjectSelected: (lat, lng) => console.log('Native Map Focus:', lat, lng),
                openCamera: (id) => {
                    console.log('Native Camera Request:', id);
                    setTimeout(() => window.onPhotoCaptured(id, "https://picsum.photos/600/400?r=" + Math.random()), 1000);
                }
            };
        }

        // --- CORE FUNCTIONS ---
        function loadProjects() {
            try {
                const json = window.Android.getProjects();
                projects = JSON.parse(json);
                renderProjects();
            } catch (e) {
                console.error("Error parsing projects", e);
            }
        }

        function renderProjects() {
            const container = document.getElementById('project-list');
            container.innerHTML = '';
            projects.forEach(p => {
                const card = document.createElement('div');
                card.className = 'project-card bg-surface rounded-xl shadow-sm border border-gray-100 overflow-hidden';
                card.innerHTML = `
                    <div class="relative h-40 w-full bg-gray-50 border-b border-gray-100">
                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="w-full h-full object-cover" id="img-${p.id}">` : `<div class="w-full h-full flex flex-col items-center justify-center bg-gray-100 text-gray-400" id="placeholder-${p.id}"><span class="text-[10px] uppercase">Sin Foto</span></div>`}
                    </div>
                    <div class="p-4">
                        <h3 class="font-bold text-gray-800">${p.name}</h3>
                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="window.Android.onProjectSelected(${p.lat}, ${p.lng})" class="py-2 px-4 bg-primary/5 text-primary rounded-lg text-sm font-bold">Localizar</button>
                            <button onclick="window.Android.openCamera('${p.id}')" class="py-2 px-4 bg-primary text-white rounded-lg text-sm font-bold">Foto</button>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        // --- PUBLIC API FOR ANDROID ---
        window.handleCamera = (id) => window.Android.openCamera(id);
        
        window.onPhotoCaptured = (projectId, uri) => {
            // Si es el botón de prueba global
            if (projectId === 'test_project_id') {
                window.Android.showToast("¡Foto de prueba recibida! " + uri);
                return;
            }
            
            const p = projects.find(p => p.id === projectId);
            if (p) {
                p.imageUrl = uri;
                renderProjects(); // Re-render simple para actualizar la UI
                window.Android.showToast("Imagen guardada");
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', loadProjects);
    </script>
</body>
</html>